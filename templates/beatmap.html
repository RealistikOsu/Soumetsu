{{ define "tpl" }}
{{ $ := . }}
{{ if ne .ReqBeatmap.ParentSetID 0 }}
<head>
	<meta property="og:type" content="website" />
	<meta name="theme-color" content="#548ACA">
	<meta property="og:url" content="https://ussr.pl/b/{{ .ReqBeatmap.ID }}" />
	<meta property="og:title" content="{{ .Beatmaps.Artist }} - {{ .Beatmaps.Title }} [{{ .ReqBeatmap.DiffName }}]" />
	<meta property="og:description" content="Beatmap By: {{ .Beatmaps.Creator }} 
	‚≠ê- {{ printf "%.2f" .ReqBeatmap.DifficultyRating }} | üéµ - {{ .ReqBeatmap.BPM }}
	| AR: {{ .ReqBeatmap.AR }} | OD: {{ .ReqBeatmap.OD }} | CS: {{ .ReqBeatmap.CS }} | HP: {{ .ReqBeatmap.HP }} |" />
	<meta property="og:image" content="https://b.ppy.sh/thumb/{{ .Beatmaps.ID }}l.jpg" />
</head>

<div class="relative min-h-screen py-8">
	<!-- Background with blur -->
	<div class="fixed inset-0 -z-10">
		<div class="absolute inset-0 bg-cover bg-center bg-no-repeat opacity-20" 
			style="background-image: url('/static/headers/beatmaps.jpg');"></div>
		<div class="absolute inset-0 bg-gradient-to-b from-dark-bg via-dark-bg/90 to-dark-bg"></div>
	</div>

	<div class="container mx-auto px-4">
		<!-- Difficulty Selector -->
		<div class="mb-6">
			<div class="relative inline-block">
				<button class="btn-secondary flex items-center gap-2" onclick="document.getElementById('diff-dropdown').classList.toggle('hidden')">
					<img src="/static/images/mode-{{ .ReqBeatmap.Mode }}.png" class="w-5 h-5">
					<span>{{ .ReqBeatmap.DiffName }} {{ printf "%.2f" .ReqBeatmap.DifficultyRating }} ‚≠ê</span>
					<i class="fas fa-chevron-down"></i>
				</button>
				<div id="diff-dropdown" class="hidden absolute top-full mt-2 bg-dark-card border border-dark-border rounded-lg shadow-lg z-10 min-w-[300px]">
					{{ range .Beatmaps.ChildrenBeatmaps }}
						<a href="/beatmaps/{{ .ID }}" class="block px-4 py-3 hover:bg-dark-bg transition-colors {{ if eq .ID $.ReqBeatmap.ID }}bg-primary/20{{ end }}">
							<div class="flex items-center gap-3">
								<img src="/static/images/mode-{{ .Mode }}.png" class="w-5 h-5">
								<span class="flex-1">{{ .DiffName }}</span>
								<span class="text-gray-400">{{ printf "%.2f" .DifficultyRating }} ‚≠ê</span>
							</div>
						</a>
					{{ end }}
				</div>
			</div>
		</div>

		<audio id="BeatmapAudio" src="https://b.ppy.sh/preview/{{ .Beatmaps.ID }}.mp3" preload="auto"></audio>

		<!-- Beatmap Info Card -->
		<div class="card mb-6">
			<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
				<div>
					<h4 class="text-sm text-gray-400 mb-1">{{ $.T "Artist" }}</h4>
					<p class="font-semibold">{{ .Beatmaps.Artist }}</p>
					<h4 class="text-sm text-gray-400 mb-1 mt-3">{{ $.T "Title" }}</h4>
					<p class="font-semibold">{{ .Beatmaps.Title }}</p>
					<h4 class="text-sm text-gray-400 mb-1 mt-3">{{ $.T "Creator" }}</h4>
					<p class="font-semibold">{{ .Beatmaps.Creator }}</p>
					<h4 class="text-sm text-gray-400 mb-1 mt-3">{{ $.T "Source" }}</h4>
					<p class="font-semibold">{{ .Beatmaps.Source }}</p>
				</div>
				<div>
					<h4 class="text-sm text-gray-400 mb-1">{{ $.T "Circle Size" }}</h4>
					<p class="font-semibold" id="cs"></p>
					<h4 class="text-sm text-gray-400 mb-1 mt-3">{{ $.T "HP Drain" }}</h4>
					<p class="font-semibold" id="hp"></p>
					<h4 class="text-sm text-gray-400 mb-1 mt-3">{{ $.T "Overall Difficulty" }}</h4>
					<p class="font-semibold" id="od"></p>
					<h4 class="text-sm text-gray-400 mb-1 mt-3">{{ $.T "Passes/Plays" }}</h4>
					<p class="font-semibold"><span id="passcount"></span> / <span id="playcount"></span></p>
				</div>
				<div>
					<h4 class="text-sm text-gray-400 mb-1">{{ $.T "Approach Rate" }}</h4>
					<p class="font-semibold" id="ar"></p>
					<h4 class="text-sm text-gray-400 mb-1 mt-3">{{ $.T "Star Difficulty" }}</h4>
					<p class="font-semibold" id="stars"></p>
					<h4 class="text-sm text-gray-400 mb-1 mt-3">{{ $.T "Length" }}</h4>
					<p class="font-semibold"><span id="length"></span> (<span id="drainLength"></span> drain)</p>
					<h4 class="text-sm text-gray-400 mb-1 mt-3">{{ $.T "BPM" }}</h4>
					<p class="font-semibold" id="bpm"></p>
				</div>
			</div>

			<div class="flex flex-wrap gap-3 justify-center pt-6 border-t border-dark-border">
				<a href="osu://dl/{{ .Beatmaps.ID }}" class="btn-secondary bg-pink-600/20 border-pink-500/50 hover:bg-pink-600/30">
					<i class="fas fa-download mr-2"></i>
					{{ $.T "osu!direct" }}
				</a>
				<a href="/d/{{ .Beatmaps.ID }}" class="btn-secondary bg-green-600/20 border-green-500/50 hover:bg-green-600/30">
					<i class="fas fa-download mr-2"></i>
					{{ $.T "Download" }}
				</a>
				<a href="{{ .Conf.BEATMAP_DOWNLOAD_MIRROR_URL }}/{{ .Beatmaps.ID }}" class="btn-secondary bg-red-600/20 border-red-500/50 hover:bg-red-600/30">
					<i class="fas fa-download mr-2"></i>
					{{ $.T "Mirror" }}
				</a>
				<button class="btn-secondary bg-purple-600/20 border-purple-500/50 hover:bg-purple-600/30" onclick="togglePlay()">
					<i class="fas fa-{{ if false }}pause{{ else }}play{{ end }} mr-2" id="imageplay"></i>
					<span id="PlayState">{{ $.T "Play" }}</span>
				</button>
			</div>
		</div>

		<script>
			{{ $p := .Gin.Query "p" }}
			{{ $favModeRaw := .Get "users/self/favourite_mode" }}

			var beatmapID = {{ .ReqBeatmap.ID }};
			var setData = JSON.parse({{ .SetJSON }});
			var page = {{ $p | atoint | atLeastOne }};

			var PlayText = '{{ $.T "Play" }}'
			var PauseText = '{{ $.T "Pause" }}'
			var currentMode = {{ atoi (.Gin.Query "mode") }};
			var currentModeChanged = false;
			var favMode = parseInt({{ $favModeRaw.favourite_mode }}) || 0;

			var myAudio = document.getElementById("BeatmapAudio");
			var isPlaying = false;
			myAudio.volume = 0.2;

			function togglePlay() {
				if (isPlaying) {
					myAudio.pause()
					document.getElementById("PlayState").innerHTML = PlayText;
					document.getElementById("imageplay").classList.remove('fa-pause');
					document.getElementById("imageplay").classList.add('fa-play');
				} else {
					myAudio.play();
					document.getElementById("PlayState").innerHTML = PauseText;
					document.getElementById("imageplay").classList.remove('fa-play');
					document.getElementById("imageplay").classList.add('fa-pause');
				}
			};
			myAudio.onplaying = function() {
				isPlaying = true;
			};
			myAudio.onpause = function() {
				isPlaying = false;
			};

			myAudio.addEventListener("ended", function(){
				myAudio.currentTime = 0;
				document.getElementById("PlayState").innerHTML = PlayText;
				document.getElementById("imageplay").classList.remove('fa-pause');
				document.getElementById("imageplay").classList.add('fa-play');
			});

			function ClearTable() {
				var Table = document.getElementById("resulttable");
				Table.innerHTML = "";
			}

			function Fill(Mode) {
				ClearTable();
				FillScores(Mode);
				UnactiveModeButtons();
				switch (Mode) {
					case 0:
						document.getElementById("vbutton").classList.add("bg-primary", "border-primary", "text-white");
						document.getElementById("vbutton").classList.remove("bg-dark-card", "border-dark-border", "text-gray-300");
						break;
					case 1:
						document.getElementById("rbutton").classList.add("bg-primary", "border-primary", "text-white");
						document.getElementById("rbutton").classList.remove("bg-dark-card", "border-dark-border", "text-gray-300");
						break;
					case 2:
						document.getElementById("abutton").classList.add("bg-primary", "border-primary", "text-white");
						document.getElementById("abutton").classList.remove("bg-dark-card", "border-dark-border", "text-gray-300");
						break;
				}
			}
			document.addEventListener('DOMContentLoaded', (event) => {
				Fill(0)
			})
			function UnactiveModeButtons () {
				document.getElementById("vbutton").classList.remove("bg-primary", "border-primary", "text-white");
				document.getElementById("vbutton").classList.add("bg-dark-card", "border-dark-border", "text-gray-300");
				document.getElementById("rbutton").classList.remove("bg-primary", "border-primary", "text-white");
				document.getElementById("rbutton").classList.add("bg-dark-card", "border-dark-border", "text-gray-300");
				document.getElementById("abutton").classList.remove("bg-primary", "border-primary", "text-white");
				document.getElementById("abutton").classList.add("bg-dark-card", "border-dark-border", "text-gray-300");
			}
		</script>

		<!-- Mode Filters -->
		<div class="flex flex-wrap gap-2 mb-4">
			<button class="px-4 py-2 rounded-lg border transition-colors bg-dark-card border-dark-border text-gray-300 hover:border-primary" onclick="Fill(0)" id="vbutton">Vanilla</button>
			<button class="px-4 py-2 rounded-lg border transition-colors bg-dark-card border-dark-border text-gray-300 hover:border-primary" onclick="Fill(1)" id="rbutton">Relax</button>
			<button class="px-4 py-2 rounded-lg border transition-colors bg-dark-card border-dark-border text-gray-300 hover:border-primary" onclick="Fill(2)" id="abutton">Autopilot</button>
		</div>
		<div class="grid grid-cols-4 gap-2 mb-6" id="mode-menu">
			{{ $currentMode := atoi ($.Gin.Query "mode") }}
			{{ range $k, $v := modes }}
				<a class="px-3 py-2 rounded-lg border text-center text-sm transition-colors {{ if eq $k $currentMode }}bg-primary border-primary text-white{{ else }}bg-dark-card border-dark-border text-gray-300 hover:border-primary{{ end }}" id="mode-{{ $k }}" data-mode="{{ $k }}" href="/beatmaps/{{ $.ReqBeatmap.ID }}?mode={{ $k }}">{{ $v }}</a>
			{{ end }}
		</div>

		<!-- Leaderboard Table -->
		<div class="card overflow-x-auto">
			<table class="w-full">
				<thead>
					<tr class="border-b border-dark-border">
						<th class="text-left py-3 px-4 text-gray-400 font-medium">{{ .T "Rank" }}</th>
						<th class="text-left py-3 px-4 text-gray-400 font-medium w-30"></th>
						<th class="text-center py-3 px-4 text-gray-400 font-medium">{{ .T "Grade" }}</th>
						<th class="text-right py-3 px-4 text-gray-400 font-medium">{{ .T "Score" }}</th>
						<th class="text-right py-3 px-4 text-gray-400 font-medium">{{ .T "Accuracy" }}</th>
						<th class="text-right py-3 px-4 text-gray-400 font-medium">{{ .T "Combo" }} ({{ .ReqBeatmap.MaxCombo }})</th>
						<th class="text-right py-3 px-4 text-gray-400 font-medium">{{ .T "PP" }}</th>
						<th class="text-center py-3 px-4 text-gray-400 font-medium">{{ .T "Mods" }}</th>
						<th class="text-right py-3 px-4 text-gray-400 font-medium">{{ .T "Time" }}</th>
						<th class="text-center py-3 px-4 text-gray-400 font-medium">{{ .T "Replay" }}</th>
					</tr>
				</thead>
				<tbody id="resulttable"></tbody>
			</table>
		</div>
	{{ end }}
</div>
{{ end }}
