{{/*###
Handler=/settings/avatar
KyutGrill=settings2.jpg
Include=menu.html
MinPrivileges=2
DisableHH=true
*/}}
{{ define "tpl" }}
<script src="/static/js/banner-gradient.js"></script>
<div class="relative min-h-screen py-8">
	<!-- Background with blur -->
	<div class="fixed inset-0 -z-10">
		<div class="absolute inset-0 bg-cover bg-center bg-no-repeat opacity-20" 
			style="background-image: url('/static/headers/settings2.jpg');"></div>
		<div class="absolute inset-0 bg-gradient-to-b from-dark-bg via-dark-bg/90 to-dark-bg"></div>
	</div>

	<div class="container mx-auto px-4">
		<div class="flex flex-col md:flex-row gap-6">
			{{ template "settingsSidebar" . }}
			
			<div class="flex-1">
				<div class="card">
					<div class="flex items-center gap-3 mb-6 pb-4 border-b border-dark-border">
						<div class="w-12 h-12 bg-primary/20 rounded-full flex items-center justify-center">
							<i class="fas fa-image text-primary text-xl"></i>
						</div>
						<div>
							<h2 class="text-2xl font-display font-bold text-white">Change Avatar</h2>
							<p class="text-sm text-gray-400">Upload a new profile picture</p>
						</div>
					</div>

					<form action="/settings/avatar" method="post" enctype="multipart/form-data" id="avatar-form">
						{{ ieForm }}
						
						<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
							<!-- Left: Current Avatar & Preview -->
							<div class="space-y-6">
								<div>
									<h3 class="text-sm font-medium text-gray-400 mb-3 flex items-center gap-2">
										<i class="fas fa-user-circle"></i>
										Current Avatar
									</h3>
									<div class="flex items-center gap-6">
										<div class="relative group">
											<img src="{{ config "APP_AVATAR_URL" .Conf }}/{{ .Context.User.ID }}" 
												alt="Current Avatar" 
												class="w-32 h-32 rounded-full border-4 border-dark-border object-cover shadow-lg">
											<div class="absolute inset-0 bg-black/50 rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
												<span class="text-white text-xs">Current</span>
											</div>
										</div>
										<div class="hidden" id="preview-arrow">
											<i class="fas fa-arrow-right text-primary text-2xl animate-pulse"></i>
										</div>
										<div class="hidden" id="preview-container">
											<div class="relative">
												<img src="" 
													alt="New Avatar Preview" 
													id="avatar-preview"
													class="w-32 h-32 rounded-full border-4 border-primary object-cover shadow-lg shadow-primary/20">
												<div class="absolute -top-2 -right-2 bg-primary text-white text-xs px-2 py-1 rounded-full">
													New
												</div>
											</div>
										</div>
									</div>
								</div>

								<!-- Profile Card Preview -->
								<div id="profile-card-preview">
									<h3 class="text-sm font-medium text-gray-400 mb-3 flex items-center gap-2">
										<i class="fas fa-id-card"></i>
										Profile Card Preview
									</h3>
									<div class="card p-0 overflow-hidden max-w-sm relative">
										<!-- "New Avatar" badge - hidden by default -->
										<div id="new-avatar-badge" class="hidden absolute top-2 left-2 z-20 bg-primary text-white text-xs px-2 py-1 rounded-full font-medium shadow-lg">
											<i class="fas fa-sparkles mr-1"></i>New Avatar
										</div>
										<!-- Banner -->
										<div class="relative h-24 overflow-hidden">
											<div class="absolute inset-0 bg-gradient-to-br from-primary/30 to-purple-500/30 banner-gradient-transition" id="avatar-preview-banner"></div>
											<div class="absolute top-2 right-2 flex flex-col items-end gap-1">
												<div class="flex items-center gap-1 text-white bg-black/50 px-2 py-0.5 rounded text-xs backdrop-blur-sm">
													<i class="fas fa-globe text-gray-400"></i>
													<span class="font-semibold">#1,234</span>
												</div>
											</div>
										</div>
										<!-- Info -->
										<div class="p-4 -mt-10 relative z-10">
											<div class="flex items-start gap-3 mb-3">
												<div class="relative">
													<img src="{{ config "APP_AVATAR_URL" .Conf }}/{{ .Context.User.ID }}" 
														id="preview-card-avatar" 
														class="w-16 h-16 rounded-full border-3 border-dark-card object-cover transition-all duration-300"
														data-original="{{ config "APP_AVATAR_URL" }}/{{ .Context.User.ID }}"
														crossorigin="anonymous">
													<!-- Ring animation when new avatar selected -->
													<div id="avatar-ring" class="hidden absolute inset-0 rounded-full border-2 border-primary animate-pulse"></div>
												</div>
											</div>
											<div class="bg-dark-bg rounded-lg p-3">
												<h4 class="text-lg font-display font-bold text-white mb-1">
													{{ .Context.User.Username }}
												</h4>
												<div class="flex items-center gap-2 text-xs text-gray-400 mb-2">
													<i class="fas fa-calendar"></i>
													<span>Joined 2024</span>
												</div>
												<div class="grid grid-cols-2 gap-2 text-xs">
													<div class="flex justify-between">
														<span class="text-gray-500">PP</span>
														<span class="text-white font-medium">4,130</span>
													</div>
													<div class="flex justify-between">
														<span class="text-gray-500">Acc</span>
														<span class="text-white font-medium">95.47%</span>
													</div>
												</div>
											</div>
										</div>
									</div>
									<p id="preview-hint" class="text-xs text-gray-500 mt-2 text-center">
										<i class="fas fa-info-circle mr-1"></i>Select an image to see how it will look
									</p>
								</div>
							</div>

							<!-- Right: Upload Area -->
							<div class="space-y-6">
								<div>
									<h3 class="text-sm font-medium text-gray-400 mb-3 flex items-center gap-2">
										<i class="fas fa-cloud-upload-alt"></i>
										Upload New Avatar
									</h3>
									
									<!-- Drag & Drop Zone -->
									<label for="file" 
										id="drop-zone"
										class="block border-2 border-dashed border-dark-border rounded-xl p-8 text-center cursor-pointer transition-all hover:border-primary hover:bg-primary/5 group">
										<div class="space-y-4">
											<div class="w-16 h-16 mx-auto bg-dark-bg rounded-full flex items-center justify-center group-hover:bg-primary/20 transition-colors">
												<i class="fas fa-cloud-upload-alt text-3xl text-gray-500 group-hover:text-primary transition-colors"></i>
											</div>
											<div>
												<p class="text-white font-medium">Drop your image here</p>
												<p class="text-sm text-gray-500">or click to browse</p>
											</div>
											<div class="flex items-center justify-center gap-2 text-xs text-gray-500">
												<span class="px-2 py-1 bg-dark-bg rounded">PNG</span>
												<span class="px-2 py-1 bg-dark-bg rounded">JPG</span>
												<span class="px-2 py-1 bg-dark-bg rounded">GIF</span>
												<span class="px-2 py-1 bg-dark-bg rounded">WEBP</span>
											</div>
										</div>
									</label>
									
									<input type="file" 
										id="file" 
										class="hidden" 
										required 
										accept="image/*" 
										name="avatar">

									<!-- File Info -->
									<div id="file-info" class="hidden mt-4 p-4 bg-green-900/20 border border-green-700 rounded-lg">
										<div class="flex items-center gap-3">
											<i class="fas fa-check-circle text-green-400 text-xl"></i>
											<div class="flex-1 min-w-0">
												<p class="text-white font-medium truncate" id="file-name">filename.png</p>
												<p class="text-sm text-gray-400" id="file-size">0 KB</p>
											</div>
											<button type="button" id="clear-file" class="text-gray-400 hover:text-red-400 transition-colors">
												<i class="fas fa-times"></i>
											</button>
										</div>
									</div>
								</div>

								<!-- Guidelines -->
								<div class="p-4 bg-blue-900/20 border border-blue-700/50 rounded-lg">
									<h4 class="text-blue-300 font-medium mb-2 flex items-center gap-2">
										<i class="fas fa-info-circle"></i>
										Guidelines
									</h4>
									<ul class="text-sm text-gray-400 space-y-1">
										<li class="flex items-start gap-2">
											<i class="fas fa-check text-green-400 mt-1 text-xs"></i>
											Use a square image for best results
										</li>
										<li class="flex items-start gap-2">
											<i class="fas fa-check text-green-400 mt-1 text-xs"></i>
											Recommended size: 256x256 pixels or larger
										</li>
										<li class="flex items-start gap-2">
											<i class="fas fa-times text-red-400 mt-1 text-xs"></i>
											No inappropriate or offensive content
										</li>
										<li class="flex items-start gap-2">
											<i class="fas fa-times text-red-400 mt-1 text-xs"></i>
											No impersonation of other users
										</li>
									</ul>
								</div>
							</div>
						</div>

						<!-- Submit Button -->
						<div class="mt-8 pt-6 border-t border-dark-border flex flex-col sm:flex-row items-center justify-between gap-4">
							<p class="text-sm text-gray-500">
								<i class="fas fa-clock mr-1"></i>
								Avatar changes may take a few minutes to update everywhere
							</p>
							<button type="submit" 
								id="submit-btn"
								disabled
								class="btn-primary inline-flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
								<i class="fas fa-save"></i>
								Save Avatar
							</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
(function() {
	var fileInput = document.getElementById('file');
	var dropZone = document.getElementById('drop-zone');
	var previewContainer = document.getElementById('preview-container');
	var previewArrow = document.getElementById('preview-arrow');
	var avatarPreview = document.getElementById('avatar-preview');
	var previewCardAvatar = document.getElementById('preview-card-avatar');
	var newAvatarBadge = document.getElementById('new-avatar-badge');
	var avatarRing = document.getElementById('avatar-ring');
	var previewHint = document.getElementById('preview-hint');
	var fileInfo = document.getElementById('file-info');
	var fileName = document.getElementById('file-name');
	var fileSize = document.getElementById('file-size');
	var clearBtn = document.getElementById('clear-file');
	var submitBtn = document.getElementById('submit-btn');
	var originalAvatarSrc = previewCardAvatar.dataset.original;

	function formatFileSize(bytes) {
		if (bytes < 1024) return bytes + ' B';
		if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
		return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
	}

	function showPreview(file) {
		if (!file) return;
		
		var url = URL.createObjectURL(file);
		
		// Show main preview (side by side comparison)
		avatarPreview.src = url;
		previewContainer.classList.remove('hidden');
		previewArrow.classList.remove('hidden');
		
		// Update profile card preview
		previewCardAvatar.src = url;
		newAvatarBadge.classList.remove('hidden');
		avatarRing.classList.remove('hidden');
		previewHint.classList.add('hidden');
		
		// Show file info
		fileName.textContent = file.name;
		fileSize.textContent = formatFileSize(file.size);
		fileInfo.classList.remove('hidden');
		
		// Enable submit
		submitBtn.disabled = false;
		
		// Update drop zone style
		dropZone.classList.add('border-primary', 'bg-primary/5');
	}

	function clearPreview() {
		fileInput.value = '';
		previewContainer.classList.add('hidden');
		previewArrow.classList.add('hidden');
		
		// Reset profile card to original avatar
		previewCardAvatar.src = originalAvatarSrc;
		newAvatarBadge.classList.add('hidden');
		avatarRing.classList.add('hidden');
		previewHint.classList.remove('hidden');
		
		fileInfo.classList.add('hidden');
		submitBtn.disabled = true;
		dropZone.classList.remove('border-primary', 'bg-primary/5');
	}

	fileInput.addEventListener('change', function() {
		if (this.files && this.files[0]) {
			showPreview(this.files[0]);
		}
	});

	clearBtn.addEventListener('click', clearPreview);

	// Drag and drop
	['dragenter', 'dragover', 'dragleave', 'drop'].forEach(function(eventName) {
		dropZone.addEventListener(eventName, function(e) {
			e.preventDefault();
			e.stopPropagation();
		});
	});

	['dragenter', 'dragover'].forEach(function(eventName) {
		dropZone.addEventListener(eventName, function() {
			dropZone.classList.add('border-primary', 'bg-primary/10');
		});
	});

	['dragleave', 'drop'].forEach(function(eventName) {
		dropZone.addEventListener(eventName, function() {
			dropZone.classList.remove('bg-primary/10');
		});
	});

	dropZone.addEventListener('drop', function(e) {
		var files = e.dataTransfer.files;
		if (files && files[0] && files[0].type.startsWith('image/')) {
			fileInput.files = files;
			showPreview(files[0]);
		}
	});

	// Initialize banner gradient using shared utility
	var bannerPreview = document.getElementById('avatar-preview-banner');
	var updateGradient = null;
	
	if (window.BannerGradient && bannerPreview) {
		updateGradient = window.BannerGradient.init('#preview-card-avatar', '#avatar-preview-banner');
	}

	// Update gradient when preview changes
	var originalShowPreview = showPreview;
	showPreview = function(file) {
		originalShowPreview(file);
		if (updateGradient) {
			setTimeout(function() {
				var avatar = document.getElementById('preview-card-avatar');
				if (avatar && avatar.complete) {
					updateGradient();
				}
			}, 100);
		}
	};
})();
</script>
{{ end }}
