{{/*###
Handler=/beatmaps
KyutGrill=leaderboard2.jpg
DisableHH=true
AdditionalJS=/static/vue/pages/beatmap_search.js
*/}}
{{ define "tpl" }}
<script src="/static/vue/vue.js"></script>
<style>
@font-face {
    font-family: FontAwesomeExtra;
    src: url(/static/extra.6f1f24ae.ttf) format("truetype");
}
.faa {
    font-family: FontAwesomeExtra;
}
.fa-extra-mode-osu:before {
    content: "\E800";
}
.fa-extra-mode-fruits:before {
    content: "\E801";
}
.fa-extra-mode-mania:before {
    content: "\E802";
}
.fa-extra-mode-taiko:before {
    content: "\E803";
}

/* Beatmap Card Styles (inspired by profile score cards) */
.beatmap-card-compact {
    min-height: 100px;
    height: auto;
    position: relative;
    overflow: hidden;
    /* Prevent expansion from absolutely positioned children */
    contain: layout;
}

.beatmap-card-bg {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    filter: blur(6px) brightness(0.35);
    transform: scale(1.05);
    z-index: 0;
    will-change: transform;
    overflow: hidden;
    border-radius: inherit;
}

.beatmap-card-overlay {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        to right,
        rgba(15, 23, 42, 0.88) 0%,
        rgba(15, 23, 42, 0.78) 40%,
        rgba(15, 23, 42, 0.68) 60%,
        rgba(15, 23, 42, 0.55) 100%
    );
    transition: opacity 0.2s ease;
    z-index: 1;
    border-radius: inherit;
}

.group:hover .beatmap-card-overlay {
    opacity: 0.85;
}

.beatmap-card-compact .relative {
    z-index: 2;
    position: relative;
    isolation: isolate;
    transform: translateZ(0);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* Ensure dropdowns can escape card overflow and don't affect layout */
[data-dropdown] {
    position: relative;
    z-index: 100;
}


.musicPlaying {
    position: relative;
}

.musicPlaying::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    height: 4px;
    background: linear-gradient(to right, #0f97ff, #548ACA);
    width: var(--progress, 0%);
    transition: width 0.1s linear;
    z-index: 10;
}
</style>

<div id="beatmap-search-app" class="relative min-h-screen py-8">
	<!-- Background with blur -->
	<div class="fixed inset-0 -z-10">
		<div class="absolute inset-0 bg-cover bg-center bg-no-repeat opacity-20" 
			style="background-image: url('/static/headers/leaderboard2.jpg');"></div>
		<div class="absolute inset-0 bg-gradient-to-b from-dark-bg via-dark-bg/90 to-dark-bg"></div>
	</div>

	<div class="container mx-auto px-4">
		<!-- Header -->
		<div class="flex items-center gap-4 mb-8">
			<div class="w-16 h-16 bg-primary/20 rounded-full flex items-center justify-center">
				<i class="fas fa-music text-primary text-2xl"></i>
			</div>
			<div>
				<h1 class="text-4xl font-display font-bold text-white">Beatmap Search</h1>
				<p class="text-gray-400">Browse and search for beatmaps</p>
			</div>
		</div>

		<!-- Search Card -->
		<div class="card mb-6">
			<div class="flex items-center gap-2 mb-4">
				<i class="fas fa-filter text-primary"></i>
				<h3 class="font-semibold text-white">Search & Filters</h3>
			</div>
			
			<div class="space-y-6">
				<!-- Search Input -->
				<div>
					<label class="block text-xs text-gray-500 uppercase tracking-wider mb-2">Search Beatmaps</label>
					<div class="relative">
						<input type="text" 
							v-model="searchQuery"
							@input="onSearchInput"
							placeholder="Search by title, artist, creator..." 
							class="input-field pr-12">
						<i class="fas fa-search absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
					</div>
				</div>

				<!-- Game Mode -->
				<div>
					<label class="block text-xs text-gray-500 uppercase tracking-wider mb-2">Game Mode</label>
					<div class="flex flex-wrap gap-2">
						<button @click="selectMode('')" 
							:class="'px-4 py-2 rounded-lg border transition-all text-sm font-medium ' + (selectedMode === '' ? 'bg-primary border-primary text-white shadow-lg shadow-primary/25' : 'bg-dark-bg border-dark-border text-gray-300 hover:border-primary hover:text-white')">
							Any
						</button>
						<button @click="selectMode('0')" 
							:class="'px-4 py-2 rounded-lg border transition-all text-sm font-medium ' + (selectedMode === '0' ? 'bg-primary border-primary text-white shadow-lg shadow-primary/25' : 'bg-dark-bg border-dark-border text-gray-300 hover:border-primary hover:text-white')">
							<i class="fas fa-circle mr-2 text-xs"></i>osu!
						</button>
						<button @click="selectMode('1')" 
							:class="'px-4 py-2 rounded-lg border transition-all text-sm font-medium ' + (selectedMode === '1' ? 'bg-primary border-primary text-white shadow-lg shadow-primary/25' : 'bg-dark-bg border-dark-border text-gray-300 hover:border-primary hover:text-white')">
							<i class="fas fa-drum mr-2 text-xs"></i>Taiko
						</button>
						<button @click="selectMode('2')" 
							:class="'px-4 py-2 rounded-lg border transition-all text-sm font-medium ' + (selectedMode === '2' ? 'bg-primary border-primary text-white shadow-lg shadow-primary/25' : 'bg-dark-bg border-dark-border text-gray-300 hover:border-primary hover:text-white')">
							<i class="fas fa-apple-alt mr-2 text-xs"></i>Catch
						</button>
						<button @click="selectMode('3')" 
							:class="'px-4 py-2 rounded-lg border transition-all text-sm font-medium ' + (selectedMode === '3' ? 'bg-primary border-primary text-white shadow-lg shadow-primary/25' : 'bg-dark-bg border-dark-border text-gray-300 hover:border-primary hover:text-white')">
							<i class="fas fa-keyboard mr-2 text-xs"></i>Mania
						</button>
					</div>
				</div>

				<!-- Rank Status -->
				<div>
					<label class="block text-xs text-gray-500 uppercase tracking-wider mb-2">Rank Status</label>
					<div class="flex flex-wrap gap-2">
						<button @click="selectStatus('NaN')" 
							:class="'px-4 py-2 rounded-lg border transition-all text-sm font-medium ' + (selectedStatus === 'NaN' ? 'bg-primary border-primary text-white shadow-lg shadow-primary/25' : 'bg-dark-bg border-dark-border text-gray-300 hover:border-primary hover:text-white')">
							Any
						</button>
						<button @click="selectStatus('1')" 
							:class="'px-4 py-2 rounded-lg border transition-all text-sm font-medium ' + (selectedStatus === '1' ? 'bg-primary border-primary text-white shadow-lg shadow-primary/25' : 'bg-dark-bg border-dark-border text-gray-300 hover:border-primary hover:text-white')">
							Ranked
						</button>
						<button @click="selectStatus('3')" 
							:class="'px-4 py-2 rounded-lg border transition-all text-sm font-medium ' + (selectedStatus === '3' ? 'bg-primary border-primary text-white shadow-lg shadow-primary/25' : 'bg-dark-bg border-dark-border text-gray-300 hover:border-primary hover:text-white')">
							Qualified
						</button>
						<button @click="selectStatus('4')" 
							:class="'px-4 py-2 rounded-lg border transition-all text-sm font-medium ' + (selectedStatus === '4' ? 'bg-primary border-primary text-white shadow-lg shadow-primary/25' : 'bg-dark-bg border-dark-border text-gray-300 hover:border-primary hover:text-white')">
							Loved
						</button>
						<button @click="selectStatus('0')" 
							:class="'px-4 py-2 rounded-lg border transition-all text-sm font-medium ' + (selectedStatus === '0' ? 'bg-primary border-primary text-white shadow-lg shadow-primary/25' : 'bg-dark-bg border-dark-border text-gray-300 hover:border-primary hover:text-white')">
							Pending
						</button>
						<button @click="selectStatus('-1')" 
							:class="'px-4 py-2 rounded-lg border transition-all text-sm font-medium ' + (selectedStatus === '-1' ? 'bg-primary border-primary text-white shadow-lg shadow-primary/25' : 'bg-dark-bg border-dark-border text-gray-300 hover:border-primary hover:text-white')">
							WIP
						</button>
						<button @click="selectStatus('-2')" 
							:class="'px-4 py-2 rounded-lg border transition-all text-sm font-medium ' + (selectedStatus === '-2' ? 'bg-primary border-primary text-white shadow-lg shadow-primary/25' : 'bg-dark-bg border-dark-border text-gray-300 hover:border-primary hover:text-white')">
							Graveyard
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Loading State -->
		<div v-if="loading && beatmaps.length === 0" class="card mb-6">
			<div class="py-16 text-center">
				<div class="w-16 h-16 mx-auto mb-4 rounded-full bg-primary/20 flex items-center justify-center">
					<i class="fas fa-spinner fa-spin text-primary text-2xl"></i>
				</div>
				<p class="text-gray-400">Searching beatmaps...</p>
			</div>
		</div>

		<!-- Results Grid -->
		<div v-if="beatmaps.length > 0" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
			<div v-for="beatmap in beatmaps" :key="beatmap.SetID" 
				class="relative">
				<div :class="'beatmap-card-compact group rounded-lg border border-dark-border hover:border-primary/50 transition-all duration-200 cursor-pointer ' + (currentlyPlaying === beatmap.SetID ? 'musicPlaying' : '')"
					@click="window.location.href = '/beatmaps/' + beatmap.ChildrenBeatmaps[0].BeatmapID">
				<!-- Blurred Background -->
				<div class="beatmap-card-bg" 
					 :style="'background-image: url(https://assets.ppy.sh/beatmaps/' + beatmap.SetID + '/covers/cover.jpg)'"></div>
				<div class="beatmap-card-overlay"></div>
				
				<!-- Content -->
				<div class="relative p-4 flex items-center gap-4">
					<!-- Cover Thumbnail -->
					<div class="flex-shrink-0 relative">
						<a :href="'/beatmaps/' + beatmap.ChildrenBeatmaps[0].BeatmapID" @click.stop>
							<img :src="'https://assets.ppy.sh/beatmaps/' + beatmap.SetID + '/covers/cover.jpg'" 
								 :alt="beatmap.Title" 
								 class="w-20 h-20 rounded-lg object-cover border-2 border-white/10 shadow-lg">
						</a>
						<!-- Play Button -->
						<button class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity beatmapPlay" 
								@click.stop="togglePlayback(beatmap.SetID, $event)">
							<i class="fas fa-play text-white text-2xl"></i>
						</button>
					</div>

					<!-- Main Info -->
					<div class="flex-1 min-w-0">
						<a :href="'/beatmaps/' + beatmap.ChildrenBeatmaps[0].BeatmapID" @click.stop class="block">
							<h3 class="text-white font-semibold text-base mb-1 truncate group-hover:text-primary transition-colors">
								<% beatmap.Title %>
							</h3>
							<p class="text-gray-300 text-sm truncate mb-2"><% beatmap.Artist %></p>
						</a>
						
						<div class="flex items-center gap-4 text-xs text-gray-300">
							<span class="flex items-center gap-1">
								<i class="fas fa-user text-gray-400"></i>
								<a :href="'https://osu.ppy.sh/u/' + encodeURIComponent(beatmap.Creator)" 
								   @click.stop
								   class="text-primary hover:underline font-medium">
									<% beatmap.Creator %>
								</a>
							</span>
							<span class="text-gray-500">•</span>
							<span class="flex items-center gap-1.5">
								<span class="text-gray-400">Difficulties:</span>
								<div class="flex items-center gap-1">
									<div v-for="diff in sortDifficulties(beatmap.ChildrenBeatmaps).slice(0, 5)" 
										 :key="diff.BeatmapID"
										 class="relative group/diff">
										<div class="faa fal" 
											 :class="'fa-extra-mode-' + modeNames[beatmap.ChildrenBeatmaps[0].Mode]"
											 :style="'color: rgb(' + getDifficultyColor(diff.DifficultyRating) + '); font-size: 1rem;'">
										</div>
										<div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-dark-card border border-dark-border rounded text-xs text-white opacity-0 group-hover/diff:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10">
											<% diff.DiffName %> - <% diff.DifficultyRating.toFixed(2) %>★
										</div>
									</div>
									<span v-if="beatmap.ChildrenBeatmaps.length > 5" class="text-gray-400 text-xs ml-1">
										+<% beatmap.ChildrenBeatmaps.length - 5 %>
									</span>
								</div>
							</span>
						</div>
					</div>

					<!-- Right Side: Status and Download -->
					<div class="flex-shrink-0 flex flex-col items-end justify-center gap-2">
						<!-- Status Badge -->
						<div>
							<span :class="'px-2 py-1 rounded text-xs font-medium border ' + getStatusInfo(beatmap.RankedStatus).color">
								<% getStatusInfo(beatmap.RankedStatus).name %>
							</span>
						</div>
						<!-- Download Buttons -->
						<div class="flex items-center gap-2 flex-wrap">
							<a v-for="source in sources" 
							   :key="source.name"
							   :href="source.mirror + beatmap.SetID" 
							   :title="'Download from ' + source.name"
							   @click.stop
							   class="px-3 py-2 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-primary/50 rounded-lg text-center text-xs text-gray-300 hover:text-white transition-all backdrop-blur-sm">
								<i class="fas fa-download"></i>
							</a>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Loading More Indicator -->
		<div v-if="loading && beatmaps.length > 0" class="text-center py-8">
			<div class="w-12 h-12 mx-auto mb-4 rounded-full bg-primary/20 flex items-center justify-center">
				<i class="fas fa-spinner fa-spin text-primary text-xl"></i>
			</div>
			<p class="text-gray-400 text-sm">Loading more beatmaps...</p>
		</div>

		<!-- Empty State -->
		<div v-if="!loading && beatmaps.length === 0" class="card">
			<div class="py-16 text-center">
				<div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-500/20 flex items-center justify-center">
					<i class="fas fa-music text-gray-500 text-2xl"></i>
				</div>
				<p class="text-gray-400">No beatmaps found</p>
				<p class="text-gray-500 text-sm mt-2">Try adjusting your search or filters</p>
			</div>
		</div>
	</div>
</div>
{{ end }}
