{{ define "navbar" }}
<nav class="bg-dark-bg/80 backdrop-blur-md border-b border-dark-border/50 sticky top-0 z-50">
	<div class="container mx-auto px-4">
		<div class="flex items-center justify-between h-16">
			<!-- Logo -->
			<div class="flex items-center gap-8">
				<a href="/"
					class="text-xl font-display font-bold text-white hover:text-primary transition-colors flex items-center gap-2">
					{{ template "logo-svg" }}
				</a>

				<!-- Navigation Links -->
				<div class="hidden md:flex items-center gap-6">
					<a href="/leaderboard"
						class="text-gray-400 hover:text-white transition-colors text-sm {{ if eq .Path "/leaderboard" }}text-white font-medium{{ end }}">
						Leaderboard
					</a>
					<a href="/clans/leaderboard"
						class="text-gray-400 hover:text-white transition-colors text-sm {{ if eq .Path "/clans/leaderboard" }}text-white font-medium{{ end }}">
						Clans
					</a>

					<!-- Beatmaps Dropdown -->
					<div class="relative group">
						<button
							class="text-gray-400 hover:text-white transition-colors text-sm flex items-center gap-1 {{ if or (eq .Path "/beatmaps") (eq .Path "/beatmaps/rank-request" ) }}text-white font-medium{{ end }}">
							Beatmaps
							<i class="fas fa-chevron-down text-xs"></i>
						</button>
						<div
							class="absolute left-0 mt-2 w-48 bg-dark-card border border-dark-border rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform group-hover:translate-y-0 translate-y-2 z-50">
							<div class="py-2">
								<a href="/beatmaps"
									class="flex items-center gap-3 px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-dark-border/50 transition-colors {{ if eq .Path "/beatmaps" }}text-white bg-dark-border/30{{ end }}">
									<i class="fas fa-list w-4"></i>
									Beatmap Listing
								</a>
								{{ if .Context.User.ID }}
								<a href="/beatmaps/rank-request"
									class="flex items-center gap-3 px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-dark-border/50 transition-colors {{ if eq .Path "/beatmaps/rank-request" }}text-white bg-dark-border/30{{ end }}">
									<i class="fas fa-star w-4"></i>
									Request Ranking
								</a>
								{{ end }}
							</div>
						</div>
					</div>

					<!-- About Dropdown -->
					<div class="relative group">
						<button
							class="text-gray-400 hover:text-white transition-colors text-sm flex items-center gap-1 {{ if or (eq .Path "/about") (eq .Path "/rules" ) (eq .Path "/patcher") (eq .Path "/team" ) }}text-white font-medium{{ end }}">
							About
							<i class="fas fa-chevron-down text-xs"></i>
						</button>
						<div
							class="absolute left-0 mt-2 w-48 bg-dark-card border border-dark-border rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform group-hover:translate-y-0 translate-y-2 z-50">
							<div class="py-2">
								<a href="/about"
									class="flex items-center gap-3 px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-dark-border/50 transition-colors {{ if eq .Path "/about" }}text-white bg-dark-border/30{{ end }}">
									<i class="fas fa-info-circle w-4"></i>
									About RealistikOsu
								</a>
								<a href="/rules"
									class="flex items-center gap-3 px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-dark-border/50 transition-colors {{ if eq .Path "/rules" }}text-white bg-dark-border/30{{ end }}">
									<i class="fas fa-gavel w-4"></i>
									Rules
								</a>
								<a href="/patcher"
									class="flex items-center gap-3 px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-dark-border/50 transition-colors {{ if eq .Path "/patcher" }}text-white bg-dark-border/30{{ end }}">
									<i class="fas fa-wrench w-4"></i>
									Patcher
								</a>
								<a href="/team"
									class="flex items-center gap-3 px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-dark-border/50 transition-colors {{ if eq .Path "/team" }}text-white bg-dark-border/30{{ end }}">
									<i class="fas fa-users w-4"></i>
									Team
								</a>
							</div>
						</div>
					</div>

					{{ $isSupporter := has .Context.User.Privileges 4 }}
					{{ if not $isSupporter }}
					<a href="/donate"
						class="relative bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white text-sm font-semibold px-4 py-2 rounded-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 {{ if eq .Path "/donate" }}ring-2 ring-pink-400 ring-offset-2 ring-offset-dark-bg{{ end }}">
						<i class="fas fa-heart mr-1.5"></i>
						Support Us
						<span class="absolute -top-1 -right-1 flex h-3 w-3">
							<span
								class="animate-ping absolute inline-flex h-full w-full rounded-full bg-pink-400 opacity-75"></span>
							<span class="relative inline-flex rounded-full h-3 w-3 bg-pink-500"></span>
						</span>
					</a>
					{{ else }}
					<a href="/donate" class="text-gray-400 hover:text-white transition-colors text-sm {{ if eq .Path "/donate" }}text-white font-medium{{ end }}">
						Support
					</a>
					{{ end }}
				</div>
			</div>

			<!-- Right Side -->
			<div class="flex items-center gap-4">
				<!-- User Search -->
				<div class="relative hidden md:block" id="user-search-container">
					<div class="relative">
						<input type="text" id="user-search-input" placeholder="Search users..." autocomplete="off"
							class="w-48 lg:w-64 bg-dark-card border border-dark-border rounded-lg pl-10 pr-4 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
						<i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
						<div id="search-loading" class="hidden absolute right-3 top-1/2 -translate-y-1/2">
							<i class="fas fa-spinner fa-spin text-gray-500"></i>
						</div>
					</div>

					<!-- Search Results Dropdown -->
					<div id="search-results"
						class="hidden absolute top-full left-0 right-0 mt-2 bg-dark-card border border-dark-border rounded-lg shadow-xl overflow-hidden z-50 max-h-96 overflow-y-auto">
						<div id="search-results-content"></div>
						<div id="search-no-results" class="hidden p-4 text-center text-gray-400 text-sm">
							<i class="fas fa-user-slash mb-2 text-lg"></i>
							<p>No users found</p>
						</div>
						<div id="search-error" class="hidden p-4 text-center text-red-400 text-sm">
							<i class="fas fa-exclamation-circle mb-2 text-lg"></i>
							<p>Error searching users</p>
						</div>
					</div>
				</div>

				{{ if .Context.User.ID }}
				<!-- User Dropdown -->
				<div class="relative group">
					<button class="flex items-center gap-3 hover:opacity-80 transition-opacity">
						<div class="hidden md:block text-right">
							<div class="text-white font-medium text-sm">{{ .Context.User.Username }}</div>
							<div class="text-xs" id="navbar-user-role">
								{{ $role := getUserRole .Context.User.Privileges }}
								{{ if $role }}
								<span class="{{ if eq $role " Admin" }}text-red-400{{ else if eq $role "Moderator" }}text-purple-400{{ else if eq $role "BAT" }}text-blue-400{{ else if eq $role "Supporter" }}text-yellow-400{{ else }}text-gray-400{{ end }}">{{ $role }}</span>
								{{ else }}
								<span class="text-gray-400" id="navbar-user-rank">Loading...</span>
								{{ end }}
							</div>
						</div>
						<div class="relative">
							<img src="{{ config "APP_AVATAR_URL" .Conf }}/{{ .Context.User.ID }}"
								alt="{{ .Context.User.Username }}"
								class="w-10 h-10 rounded-full border-2 border-dark-border group-hover:border-primary transition-colors">
							<div id="navbar-online-indicator"
								class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-dark-bg bg-gray-500">
							</div>
						</div>
					</button>

					<!-- Dropdown Menu -->
					<div
						class="absolute right-0 mt-2 w-48 bg-dark-card border border-dark-border rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform group-hover:translate-y-0 translate-y-2">
						<div class="py-2">
							<a href="/users/{{ .Context.User.ID }}"
								class="flex items-center gap-3 px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-dark-border/50 transition-colors">
								<i class="fas fa-user w-4"></i>
								My Profile
							</a>
							<a href="/friends"
								class="flex items-center gap-3 px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-dark-border/50 transition-colors">
								<i class="fas fa-user-friends w-4"></i>
								Friends
							</a>
							{{ if .Context.User.Clan }}
							<a href="/clans/{{ .Context.User.Clan }}"
								class="flex items-center gap-3 px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-dark-border/50 transition-colors">
								<i class="fas fa-shield-alt w-4"></i>
								My Clan
							</a>
							{{ end }}
							<a href="/settings"
								class="flex items-center gap-3 px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-dark-border/50 transition-colors">
								<i class="fas fa-cog w-4"></i>
								Settings
							</a>
							<hr class="my-2 border-dark-border">
							<a href="/logout?k={{ .Session.Get "logout" }}"
								class="flex items-center gap-3 px-4 py-2 text-sm text-red-400 hover:text-red-300 hover:bg-dark-border/50 transition-colors">
								<i class="fas fa-sign-out-alt w-4"></i>
								Logout
							</a>
						</div>
					</div>
				</div>
				{{ else }}
				<!-- Login/Register Links -->
				<div class="flex items-center gap-3">
					<a href="/login" class="text-gray-400 hover:text-white transition-colors text-sm">Log in</a>
					<a href="/register"
						class="bg-primary hover:bg-primary-dark text-white text-sm font-medium px-4 py-2 rounded-lg transition-colors">Register</a>
				</div>
				{{ end }}

				<!-- Mobile Menu Button -->
				<button class="md:hidden text-gray-400 hover:text-white p-2" id="mobile-menu-btn"
					onclick="document.getElementById('mobile-menu').classList.toggle('hidden')">
					<i class="fas fa-bars"></i>
				</button>
			</div>
		</div>

		<!-- Mobile Menu -->
		<div id="mobile-menu" class="hidden md:hidden pb-4">
			<!-- Mobile Search -->
			<div class="relative mb-4" id="mobile-search-container">
				<input type="text" id="mobile-search-input" placeholder="Search users..." autocomplete="off"
					class="w-full bg-dark-card border border-dark-border rounded-lg pl-10 pr-4 py-3 text-sm text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
				<i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
				<div id="mobile-search-results"
					class="hidden absolute top-full left-0 right-0 mt-2 bg-dark-card border border-dark-border rounded-lg shadow-xl overflow-hidden z-50 max-h-64 overflow-y-auto">
					<div id="mobile-search-results-content"></div>
				</div>
			</div>

			<div class="flex flex-col gap-2">
				<a href="/leaderboard"
					class="text-gray-400 hover:text-white transition-colors py-2 px-4 rounded-lg hover:bg-dark-card">
					Leaderboard
				</a>
				<a href="/clans/leaderboard"
					class="text-gray-400 hover:text-white transition-colors py-2 px-4 rounded-lg hover:bg-dark-card">
					Clan
				</a>

				<!-- Beatmaps Section -->
				<div class="px-4 py-2">
					<div class="text-gray-400 text-sm font-medium mb-1">Beatmaps</div>
					<div class="flex flex-col gap-1 ml-4">
						<a href="/beatmaps"
							class="text-gray-400 hover:text-white transition-colors py-1 px-2 rounded hover:bg-dark-card">
							Beatmap Listing
						</a>
						{{ if .Context.User.ID }}
						<a href="/beatmaps/rank-request"
							class="text-gray-400 hover:text-white transition-colors py-1 px-2 rounded hover:bg-dark-card">
							Request Ranking
						</a>
						{{ end }}
					</div>
				</div>

				<!-- About Section -->
				<div class="px-4 py-2">
					<div class="text-gray-400 text-sm font-medium mb-1">About</div>
					<div class="flex flex-col gap-1 ml-4">
						<a href="/about"
							class="text-gray-400 hover:text-white transition-colors py-1 px-2 rounded hover:bg-dark-card">
							About RealistikOsu
						</a>
						<a href="/rules"
							class="text-gray-400 hover:text-white transition-colors py-1 px-2 rounded hover:bg-dark-card">
							Rules
						</a>
						<a href="/patcher"
							class="text-gray-400 hover:text-white transition-colors py-1 px-2 rounded hover:bg-dark-card">
							Patcher
						</a>
						<a href="/team"
							class="text-gray-400 hover:text-white transition-colors py-1 px-2 rounded hover:bg-dark-card">
							Team
						</a>
					</div>
				</div>

				{{ $isSupporter := has .Context.User.Privileges 4 }}
				{{ if not $isSupporter }}
				<a href="/donate"
					class="relative bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center gap-2 {{ if eq .Path "/donate" }}ring-2 ring-pink-400 ring-offset-2 ring-offset-dark-bg{{ end }}">
					<i class="fas fa-heart"></i>
					Support Us
					<span class="absolute -top-1 -right-1 flex h-3 w-3">
						<span
							class="animate-ping absolute inline-flex h-full w-full rounded-full bg-pink-400 opacity-75"></span>
						<span class="relative inline-flex rounded-full h-3 w-3 bg-pink-500"></span>
					</span>
				</a>
				{{ else }}
				<a href="/donate"
					class="text-gray-400 hover:text-white transition-colors py-2 px-4 rounded-lg hover:bg-dark-card">
					Support
				</a>
				{{ end }}
			</div>
		</div>
	</div>
</nav>

{{ if .Context.User.ID }}
<script>
	(function () {
		var userId = {{ .Context.User.ID }};
		var indicator = document.getElementById('navbar-online-indicator');
		var rankEl = document.getElementById('navbar-user-rank');

		// Fetch online status from Bancho API
		if (indicator && typeof soumetsuConf !== 'undefined' && soumetsuConf.banchoAPI) {
			fetch(soumetsuConf.banchoAPI + '/api/status/' + userId)
				.then(function (r) { return r.json(); })
				.then(function (data) {
					if (data.status === 200) {
					indicator.classList.remove('bg-gray-500');
					indicator.classList.add('bg-green-500');
				} else {
					indicator.classList.remove('bg-gray-500');
					indicator.classList.add('bg-gray-600');
				}
			})
			.catch(function () {
				indicator.classList.remove('bg-gray-500');
				indicator.classList.add('bg-gray-600');
			});
		}

		// Fetch rank if rank element exists (user is not staff)
		if (rankEl && typeof soumetsuConf !== 'undefined' && soumetsuConf.baseAPI) {
			fetch(soumetsuConf.baseAPI + '/api/v2/users/' + userId + '/card')
				.then(function (r) { return r.json(); })
			.then(function (json) {
				var data = json.data !== undefined ? json.data : json;
				if (data && data.global_rank > 0) {
					rankEl.textContent = '#' + data.global_rank.toLocaleString();
				} else {
					rankEl.textContent = 'Unranked';
				}
			})
			.catch(function () {
				rankEl.textContent = '';
			});
		}
	})();
</script>
{{ end }}

<!-- User Search Script -->
<script>
	(function () {
		var avatarUrl = typeof soumetsuConf !== 'undefined' ? soumetsuConf.avatars : '';
		var apiUrl = typeof soumetsuConf !== 'undefined' ? soumetsuConf.baseAPI : '';

		function getRoleInfo(privileges) {
			// Admin (ManageUsers)
			if (privileges & 8192) return { name: 'Admin', color: 'text-red-400', bg: 'bg-red-500/20' };
			// Moderator (AccessRAP)
			if (privileges & 4096) return { name: 'Moderator', color: 'text-purple-400', bg: 'bg-purple-500/20' };
			// Donor
			if (privileges & 4) return { name: 'Supporter', color: 'text-yellow-400', bg: 'bg-yellow-500/20' };
			return null;
		}

		function formatNumber(num) {
			return num ? num.toLocaleString() : '0';
		}

		// Escape HTML to prevent XSS
		function escapeHtml(text) {
			if (!text) return '';
			var div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}

		// Validate country code (2-letter ISO)
		function isValidCountryCode(code) {
			return code && /^[A-Za-z]{2}$/.test(code);
		}

		// Safe user rendering using DOM methods
		function renderUserElement(user) {
			// Validate user ID is numeric
			var userId = parseInt(user.id, 10);
			if (isNaN(userId) || userId <= 0) return null;

			var role = getRoleInfo(user.privileges || 0);
			var rank = user.stats && user.stats.vn && user.stats.vn.std ? user.stats.vn.std.global_leaderboard_rank : null;
			var pp = user.stats && user.stats.vn && user.stats.vn.std ? Math.round(user.stats.vn.std.pp) : null;

			// Create link element
			var link = document.createElement('a');
			link.href = '/users/' + userId;
			link.className = 'flex items-center gap-3 p-3 hover:bg-dark-border/50 transition-colors border-b border-dark-border/50 last:border-0';

			// Avatar image
			var avatar = document.createElement('img');
			avatar.src = avatarUrl + '/' + userId;
			avatar.className = 'w-10 h-10 rounded-full border-2 border-dark-border object-cover';
			avatar.alt = escapeHtml(user.username || 'User');
			avatar.loading = 'lazy';
			link.appendChild(avatar);

			// Content container
			var content = document.createElement('div');
			content.className = 'flex-1 min-w-0';

			// Name row
			var nameRow = document.createElement('div');
			nameRow.className = 'flex items-center gap-2';

			var nameSpan = document.createElement('span');
			nameSpan.className = 'text-white font-medium truncate';
			nameSpan.textContent = user.username || 'Unknown'; // textContent auto-escapes
			nameRow.appendChild(nameSpan);

			// Country flag (if valid)
			if (isValidCountryCode(user.country)) {
				var flag = document.createElement('img');
				flag.src = '/static/images/new-flags/flag-' + user.country.toLowerCase() + '.svg';
				flag.className = 'w-4 h-3 rounded';
				flag.alt = user.country.toUpperCase();
				nameRow.appendChild(flag);
			}

			content.appendChild(nameRow);

			// Stats row
			var statsRow = document.createElement('div');
			statsRow.className = 'flex items-center gap-2 mt-0.5';

			if (role) {
				var roleSpan = document.createElement('span');
				roleSpan.className = 'text-xs px-2 py-0.5 rounded ' + role.bg + ' ' + role.color;
				roleSpan.textContent = role.name;
				statsRow.appendChild(roleSpan);
			} else if (rank) {
				var rankSpan = document.createElement('span');
				rankSpan.className = 'text-xs text-gray-400';
				rankSpan.textContent = '#' + formatNumber(rank);
				statsRow.appendChild(rankSpan);
			}

			if (pp) {
				var ppSpan = document.createElement('span');
				ppSpan.className = 'text-xs text-primary';
				ppSpan.textContent = formatNumber(pp) + 'pp';
				statsRow.appendChild(ppSpan);
			}

			content.appendChild(statsRow);
			link.appendChild(content);

			// Chevron icon
			var chevron = document.createElement('i');
			chevron.className = 'fas fa-chevron-right text-gray-500 text-xs';
			link.appendChild(chevron);

			return link;
		}

		// Legacy function for backwards compatibility (deprecated)
		function renderUserHtml(user) {
			var el = renderUserElement(user);
			if (!el) return '';
			var wrapper = document.createElement('div');
			wrapper.appendChild(el);
			return wrapper.innerHTML;
		}

		function initSearch(inputId, resultsId, contentId, containerId, noResultsId, errorId, loadingId) {
			var searchInput = document.getElementById(inputId);
			var searchResults = document.getElementById(resultsId);
			var searchResultsContent = document.getElementById(contentId);
			var searchNoResults = noResultsId ? document.getElementById(noResultsId) : null;
			var searchError = errorId ? document.getElementById(errorId) : null;
			var searchLoading = loadingId ? document.getElementById(loadingId) : null;
			var searchTimeout = null;

			if (!searchInput || !searchResults) return;

			function renderResults(users) {
				// Clear existing content safely
				while (searchResultsContent.firstChild) {
					searchResultsContent.removeChild(searchResultsContent.firstChild);
				}

				if (!users || users.length === 0) {
					// Create "no results" message using DOM methods
					var noResultsDiv = document.createElement('div');
					noResultsDiv.className = 'p-4 text-center text-gray-400 text-sm';
					var icon = document.createElement('i');
					icon.className = 'fas fa-user-slash mb-2 text-lg block';
					noResultsDiv.appendChild(icon);
					noResultsDiv.appendChild(document.createTextNode('No users found'));
					searchResultsContent.appendChild(noResultsDiv);

					if (searchNoResults) {
						searchNoResults.classList.remove('hidden');
					}
					if (searchError) {
						searchError.classList.add('hidden');
					}
					return;
				}

				if (searchNoResults) searchNoResults.classList.add('hidden');
				if (searchError) searchError.classList.add('hidden');

				// Render users safely using DOM methods
				users.forEach(function(user) {
					var el = renderUserElement(user);
					if (el) {
						searchResultsContent.appendChild(el);
					}
				});
			}

			function doSearch(query) {
				if (!query || query.length < 2) {
					searchResults.classList.add('hidden');
					return;
				}

				if (searchLoading) searchLoading.classList.remove('hidden');
				searchResults.classList.remove('hidden');

				// Show loading spinner using DOM methods
				while (searchResultsContent.firstChild) {
					searchResultsContent.removeChild(searchResultsContent.firstChild);
				}
				var loadingDiv = document.createElement('div');
				loadingDiv.className = 'p-4 text-center text-gray-400';
				var spinner = document.createElement('i');
				spinner.className = 'fas fa-spinner fa-spin';
				loadingDiv.appendChild(spinner);
				searchResultsContent.appendChild(loadingDiv);

				if (searchNoResults) searchNoResults.classList.add('hidden');
				if (searchError) searchError.classList.add('hidden');

				fetch(apiUrl + '/api/v2/users/search?q=' + encodeURIComponent(query) + '&limit=8')
					.then(function (r) { return r.json(); })
					.then(function (json) {
						if (searchLoading) searchLoading.classList.add('hidden');
						var data = json.data !== undefined ? json.data : json;
						if (Array.isArray(data) && data.length > 0) {
							renderResults(data);
						} else {
							renderResults([]);
						}
					})
					.catch(function () {
						if (searchLoading) searchLoading.classList.add('hidden');
						// Show error using DOM methods
						while (searchResultsContent.firstChild) {
							searchResultsContent.removeChild(searchResultsContent.firstChild);
						}
						var errorDiv = document.createElement('div');
						errorDiv.className = 'p-4 text-center text-red-400 text-sm';
						var errorIcon = document.createElement('i');
						errorIcon.className = 'fas fa-exclamation-circle mb-2 text-lg block';
						errorDiv.appendChild(errorIcon);
						errorDiv.appendChild(document.createTextNode('Error searching'));
						searchResultsContent.appendChild(errorDiv);
					});
			}

			searchInput.addEventListener('input', function () {
				var query = this.value.trim();

				if (searchTimeout) {
					clearTimeout(searchTimeout);
				}

				if (query.length < 2) {
					searchResults.classList.add('hidden');
					return;
				}

				searchTimeout = setTimeout(function () {
					doSearch(query);
				}, 300);
			});

			searchInput.addEventListener('focus', function () {
				if (this.value.trim().length >= 2) {
					searchResults.classList.remove('hidden');
				}
			});

			// Close search results when clicking outside
			document.addEventListener('click', function (e) {
				var container = document.getElementById(containerId);
				if (container && !container.contains(e.target)) {
					searchResults.classList.add('hidden');
				}
			});

			// Handle keyboard navigation
			searchInput.addEventListener('keydown', function (e) {
				if (e.key === 'Escape') {
					searchResults.classList.add('hidden');
					this.blur();
				}
				if (e.key === 'Enter') {
					var firstResult = searchResultsContent.querySelector('a');
					if (firstResult) {
						window.location.href = firstResult.href;
					}
				}
			});
		}

		// Initialize desktop search
		initSearch('user-search-input', 'search-results', 'search-results-content', 'user-search-container', 'search-no-results', 'search-error', 'search-loading');

		// Initialize mobile search
		initSearch('mobile-search-input', 'mobile-search-results', 'mobile-search-results-content', 'mobile-search-container', null, null, null);
	})();
</script>
{{ end }}
