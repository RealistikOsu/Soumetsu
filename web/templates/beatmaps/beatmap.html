{{/*###
DisableHH=true
*/}}
{{ define "tpl" }}
<script>
	window.beatmapId = {{ .BeatmapID }};
</script>

<div id="beatmap-app" class="relative min-h-screen py-8">
	<!-- Background with blur -->
	<div class="fixed inset-0 -z-10">
		<div class="absolute inset-0 bg-cover bg-center bg-no-repeat opacity-20"
			style="background-image: url('/static/headers/beatmaps.jpg');"></div>
		<div class="absolute inset-0 bg-gradient-to-b from-dark-bg via-dark-bg/90 to-dark-bg"></div>
	</div>

	<!-- Loading State -->
	<div v-if="loading" class="container mx-auto px-4">
		<div class="card flex items-center justify-center py-16">
			<i class="fas fa-spinner fa-spin text-primary text-4xl"></i>
		</div>
	</div>

	<!-- Error State -->
	<div v-else-if="error" class="container mx-auto px-4">
		<div class="card text-center py-16">
			<i class="fas fa-music text-gray-500 text-5xl mb-4"></i>
			<h2 class="text-2xl font-bold text-white mb-2">Beatmap Not Found</h2>
			<p class="text-gray-400">{{ v "error" }}</p>
		</div>
	</div>

	<!-- Beatmap Content -->
	<div v-else class="container mx-auto px-4">
		<!-- OG Meta (for sharing) -->
		<head v-if="beatmapSet">
			<meta property="og:type" content="website" />
			<meta name="theme-color" content="#548ACA">
			<meta property="og:title" :content="beatmapSet.Artist + ' - ' + beatmapSet.Title + ' [' + selectedDiff.DiffName + ']'" />
			<meta property="og:image" :content="thumbUrl" />
		</head>

		<!-- Audio element -->
		<audio ref="audio" :src="audioUrl" preload="auto"
			@playing="onAudioPlay" @pause="onAudioPause" @ended="onAudioEnded"></audio>

		<!-- Difficulty Selector -->
		<div class="mb-6 diff-dropdown-container">
			<div class="relative inline-block">
				<button class="btn-secondary flex items-center gap-2" @click="showDiffDropdown = !showDiffDropdown">
					<img :src="'/static/images/mode-' + selectedDiff.Mode + '.png'" class="w-5 h-5">
					<span>{{ v "selectedDiff.DiffName" }} {{ v "selectedDiff.DifficultyRating.toFixed(2)" }}</span>
					<i class="fas fa-chevron-down"></i>
				</button>
				<div v-show="showDiffDropdown" class="absolute top-full mt-2 bg-dark-card border border-dark-border rounded-lg shadow-lg z-10 min-w-[300px]">
					<a v-for="diff in sortedDifficulties" :key="diff.BeatmapID"
					   @click="selectDifficulty(diff)"
					   class="block px-4 py-3 hover:bg-dark-bg transition-colors cursor-pointer"
					   :class="{ 'bg-primary/20': diff.BeatmapID === selectedDiff.BeatmapID }">
						<div class="flex items-center gap-3">
							<img :src="'/static/images/mode-' + diff.Mode + '.png'" class="w-5 h-5">
							<span class="flex-1">{{ v "diff.DiffName" }}</span>
							<span class="text-gray-400">{{ v "diff.DifficultyRating.toFixed(2)" }}</span>
						</div>
					</a>
				</div>
			</div>
		</div>

		<!-- Beatmap Info Card -->
		<div class="card mb-6">
			<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
				<div>
					<h4 class="text-sm text-gray-400 mb-1">Artist</h4>
					<p class="font-semibold">{{ v "beatmapSet.Artist" }}</p>
					<h4 class="text-sm text-gray-400 mb-1 mt-3">Title</h4>
					<p class="font-semibold">{{ v "beatmapSet.Title" }}</p>
					<h4 class="text-sm text-gray-400 mb-1 mt-3">Creator</h4>
					<p class="font-semibold">{{ v "beatmapSet.Creator" }}</p>
					<h4 class="text-sm text-gray-400 mb-1 mt-3">Source</h4>
					<p class="font-semibold">{{ v "beatmapSet.Source || '-'" }}</p>
				</div>
				<div>
					<h4 class="text-sm text-gray-400 mb-1">Circle Size</h4>
					<p class="font-semibold">{{ v "selectedDiff.CS" }}</p>
					<h4 class="text-sm text-gray-400 mb-1 mt-3">HP Drain</h4>
					<p class="font-semibold">{{ v "selectedDiff.HP" }}</p>
					<h4 class="text-sm text-gray-400 mb-1 mt-3">Overall Difficulty</h4>
					<p class="font-semibold">{{ v "selectedDiff.OD" }}</p>
					<h4 class="text-sm text-gray-400 mb-1 mt-3">Passes/Plays</h4>
					<p class="font-semibold">{{ v "addCommas(selectedDiff.Passcount || 0)" }} / {{ v "addCommas(selectedDiff.Playcount || 0)" }}</p>
				</div>
				<div>
					<h4 class="text-sm text-gray-400 mb-1">Approach Rate</h4>
					<p class="font-semibold">{{ v "selectedDiff.AR" }}</p>
					<h4 class="text-sm text-gray-400 mb-1 mt-3">Star Difficulty</h4>
					<p class="font-semibold">{{ v "selectedDiff.DifficultyRating.toFixed(2)" }}</p>
					<h4 class="text-sm text-gray-400 mb-1 mt-3">Length</h4>
					<p class="font-semibold">{{ v "timeFormat(selectedDiff.TotalLength)" }} ({{ v "timeFormat(selectedDiff.HitLength)" }} drain)</p>
					<h4 class="text-sm text-gray-400 mb-1 mt-3">BPM</h4>
					<p class="font-semibold">{{ v "selectedDiff.BPM" }}</p>
				</div>
			</div>

			<div class="flex flex-wrap gap-3 justify-center pt-6 border-t border-dark-border">
				<a :href="'osu://dl/' + beatmapSet.SetID" class="btn-secondary bg-pink-600/20 border-pink-500/50 hover:bg-pink-600/30">
					<i class="fas fa-download mr-2"></i>
					osu!direct
				</a>
				<a :href="'/d/' + beatmapSet.SetID" class="btn-secondary bg-green-600/20 border-green-500/50 hover:bg-green-600/30">
					<i class="fas fa-download mr-2"></i>
					Download
				</a>
				<button class="btn-secondary bg-purple-600/20 border-purple-500/50 hover:bg-purple-600/30" @click="toggleAudio">
					<i class="fas mr-2" :class="isPlaying ? 'fa-pause' : 'fa-play'"></i>
					{{ v "isPlaying ? 'Pause' : 'Play'" }}
				</button>
			</div>
		</div>

		<!-- Relax Mode Filters -->
		<div class="flex flex-wrap gap-2 mb-4">
			<button class="px-4 py-2 rounded-lg border transition-colors"
				:class="relax === 0 ? 'bg-primary border-primary text-white' : 'bg-dark-card border-dark-border text-gray-300 hover:border-primary'"
				@click="setRelax(0)">Vanilla</button>
			<button class="px-4 py-2 rounded-lg border transition-colors"
				:class="relax === 1 ? 'bg-primary border-primary text-white' : 'bg-dark-card border-dark-border text-gray-300 hover:border-primary'"
				@click="setRelax(1)">Relax</button>
			<button class="px-4 py-2 rounded-lg border transition-colors"
				:class="relax === 2 ? 'bg-primary border-primary text-white' : 'bg-dark-card border-dark-border text-gray-300 hover:border-primary'"
				@click="setRelax(2)">Autopilot</button>
		</div>

		<!-- Mode Filters (only for std maps) -->
		<div v-if="showModeMenu" class="grid grid-cols-4 gap-2 mb-6">
			<button v-for="(name, m) in ['Standard', 'Taiko', 'Catch', 'Mania']" :key="m"
				class="px-3 py-2 rounded-lg border text-center text-sm transition-colors"
				:class="mode === m ? 'bg-primary border-primary text-white' : 'bg-dark-card border-dark-border text-gray-300 hover:border-primary'"
				@click="setMode(m)">
				{{ v "name" }}
			</button>
		</div>

		<!-- Leaderboard Table -->
		<div class="card overflow-x-auto">
			<table class="w-full">
				<thead>
					<tr class="border-b border-dark-border">
						<th class="text-left py-3 px-4 text-gray-400 font-medium">Rank</th>
						<th class="text-left py-3 px-4 text-gray-400 font-medium w-30"></th>
						<th class="text-center py-3 px-4 text-gray-400 font-medium">Grade</th>
						<th class="text-right py-3 px-4 text-gray-400 font-medium">Score</th>
						<th class="text-right py-3 px-4 text-gray-400 font-medium">Accuracy</th>
						<th class="text-right py-3 px-4 text-gray-400 font-medium">Combo ({{ v "selectedDiff.MaxCombo" }})</th>
						<th class="text-right py-3 px-4 text-gray-400 font-medium">PP</th>
						<th class="text-center py-3 px-4 text-gray-400 font-medium">Mods</th>
						<th class="text-right py-3 px-4 text-gray-400 font-medium">Time</th>
						<th class="text-center py-3 px-4 text-gray-400 font-medium">Replay</th>
					</tr>
				</thead>
				<tbody>
					<!-- Loading scores -->
					<tr v-if="scoresLoading">
						<td colspan="10" class="py-8 text-center text-gray-400">
							<i class="fas fa-spinner fa-spin mr-2"></i> Loading scores...
						</td>
					</tr>

					<!-- No scores -->
					<tr v-else-if="scores.length === 0">
						<td colspan="10" class="py-8 text-center text-gray-400">
							No scores yet. Be the first!
						</td>
					</tr>

					<!-- Score rows -->
					<tr v-for="(score, index) in scores" :key="score.id" class="border-b border-dark-border/50 hover:bg-dark-bg/50">
						<td class="py-3 px-4 text-gray-300">#{{ v "index + 1" }}</td>
						<td class="py-3 px-4">
							<a :href="'/users/' + score.user.id" class="flex items-center gap-2 text-white hover:text-primary">
								<img :src="'/static/images/new-flags/flag-' + score.user.country.toLowerCase() + '.svg'" class="w-5 h-4">
								{{ v "score.user.username" }}
							</a>
						</td>
						<td class="py-3 px-4 text-center">
							<span class="score-rank" :class="getRankClass(getRank(mode, score.mods, score.accuracy, score.count_300, score.count_100, score.count_50, score.count_miss))">
								{{ v "getRank(mode, score.mods, score.accuracy, score.count_300, score.count_100, score.count_50, score.count_miss)" }}
							</span>
						</td>
						<td class="py-3 px-4 text-right text-white">{{ v "addCommas(score.score)" }}</td>
						<td class="py-3 px-4 text-right text-white">{{ v "formatAccuracy(score.accuracy)" }}%</td>
						<td class="py-3 px-4 text-right text-white">{{ v "addCommas(score.max_combo)" }}x</td>
						<td class="py-3 px-4 text-right text-primary font-semibold">{{ v "score.pp.toFixed(0)" }}pp</td>
						<td class="py-3 px-4 text-center text-gray-300">{{ v "getScoreMods(score.mods).join('') || 'NM'" }}</td>
						<td class="py-3 px-4 text-right text-gray-400">{{ v "timeSince(score.time)" }}</td>
						<td class="py-3 px-4 text-center">
							<a :href="'/web/replays/' + score.id" class="text-primary hover:text-primary-dark">
								<i class="fas fa-download"></i>
							</a>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
</div>

<script src="/static/vue/vue.js"></script>
<script src="/static/vue/soumetsu-app.js"></script>
<script src="/static/vue/api-client.js"></script>
<script src="/static/vue/pages/beatmap.js"></script>
{{ end }}
