{{/*###
Include=clan_members.html
DisableHH=true
*/}}
{{ define "tpl" }}

{{ $mode := .Gin.Query "mode" }}
{{ if eq $mode "" }}
	{{ $mode = 0 }}
{{ end }}

{{ $relax := .Gin.Query "rx" }}
{{ if eq $relax "" }}
	{{ $relax = 0 }}
{{ end }}
<script>
	window.clanID = {{ .ClanID }}
	window.mode = {{ $mode }};
	window.relax = {{ $relax }};
</script>

<div class="relative min-h-screen py-8">
	<!-- Background with blur -->
	<div class="fixed inset-0 -z-10">
		<div class="absolute inset-0 bg-cover bg-center bg-no-repeat opacity-20" 
			style="background-image: url('/static/headers/clans.jpg');"></div>
		<div class="absolute inset-0 bg-gradient-to-b from-dark-bg via-dark-bg/90 to-dark-bg"></div>
	</div>

	<div class="container mx-auto px-4">
		{{ if .ClanID }}
			{{ $global := . }}
			{{ range (.Get "clans?id=%d" .ClanID).clans }}
				<!-- Clan Header -->
				<div class="card mb-6">
					<div class="flex flex-col md:flex-row items-start md:items-center gap-6">
						{{ if .icon }}
							<img src="{{ .icon }}" alt="Clan Icon" class="w-24 h-24 rounded-lg border-2 border-dark-border">
						{{ end }}
						<div class="flex-1">
							<div class="text-gray-400 mb-1">{{ $global.T "[%s]" (.tag | htmlescaper) | html }}</div>
							<h1 class="text-4xl font-display font-bold mb-2">{{ $global.T "%s" .name | html }}</h1>
							<p class="text-gray-300">{{ $global.T "%s" (.description | htmlescaper) | html }}</p>
						</div>
					</div>
				</div>

				<!-- Mode/Relax Tabs -->
				<div class="grid grid-cols-3 gap-2 mb-4" id="relax-menu">
					<a id="clickVanilla" class="px-4 py-2 rounded-lg border text-center transition-colors {{ if eq 0 (int $relax) }}bg-primary border-primary text-white{{ else }}bg-dark-card border-dark-border text-gray-300 hover:border-primary{{ end }}" data-rx="0" href="/c/{{ .id }}?mode={{ $mode }}&rx=0">Vanilla</a>
					<a id="clickRelax" class="px-4 py-2 rounded-lg border text-center transition-colors {{ if eq 1 (int $relax) }}bg-primary border-primary text-white{{ else }}bg-dark-card border-dark-border text-gray-300 hover:border-primary{{ end }}" data-rx="1" href="/c/{{ .id }}?mode={{ $mode }}&rx=1">Relax</a>
					<a id="clickAutopilot" class="px-4 py-2 rounded-lg border text-center transition-colors {{ if eq 2 (int $relax) }}bg-primary border-primary text-white{{ else }}bg-dark-card border-dark-border text-gray-300 hover:border-primary{{ end }}" data-rx="2" href="/c/{{ .id }}?mode={{ $mode }}&rx=2">Autopilot</a>
				</div>
				<div class="grid grid-cols-4 gap-2 mb-6" id="mode-menu">
					{{ $id := .id }}
					{{ range $k, $v := modes }}
						<a id="click{{ $v }}" class="px-3 py-2 rounded-lg border text-center text-sm transition-colors {{ if eq $k (int $mode) }}bg-primary border-primary text-white{{ else }}bg-dark-card border-dark-border text-gray-300 hover:border-primary{{ end }}" data-mode="{{ $k }}" href="/c/{{ $id }}?mode={{ $k }}&rx={{ $relax }}">{{ $v }}</a>
					{{ end }}
				</div>

				<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
					<!-- Clan Statistics -->
					<div class="card">
						<div class="flex items-center gap-3 mb-4 pb-4 border-b border-dark-border">
							<i class="fas fa-chart-line text-primary"></i>
							<h3 class="text-xl font-display font-bold">{{ $global.T "Clan Statistics" }}</h3>
						</div>
						<div id="stats-zone">
							{{ range _range 4 }}
								<div data-mode="{{ . }}" data-rx="0" {{ if _or (ne . (int $mode)) (ne 0 (int $relax)) }} hidden{{ end }} data-loaded="0"></div>
								<div data-mode="{{ . }}" data-rx="1" {{ if _or (ne . (int $mode)) (ne 1 (int $relax)) }} hidden{{ end }} data-loaded="0"></div>
								<div data-mode="{{ . }}" data-rx="2" {{ if _or (ne . (int $mode)) (ne 2 (int $relax)) }} hidden{{ end }} data-loaded="0"></div>
							{{ end }}
						</div>
					</div>

					<!-- Clan Actions & Owner -->
					<div class="space-y-6">
						{{ if $global.Context.User.ID }}
							{{ $d := qb "SELECT user, clan, perms FROM user_clans WHERE user = ? LIMIT 1" .Context.User.ID }}
							{{ $p := qb "SELECT user, clan, perms FROM user_clans WHERE user = ? AND perms = 8 LIMIT 1" .Context.User.ID }}
							{{ $tc := qb "SELECT user, clan, perms FROM user_clans WHERE user = ? AND clan = ? LIMIT 1" .Context.User.ID .ClanID }}
							{{ $uc := or $d.clan.Int -1 }}
							{{ if $d }}
								{{ if $tc }}
									{{ if $p }}
										<form id="disband-form" method="post" action="/c/{{ .ClanID }}">
											{{ ieForm .Gin }}
										</form>
										<button type="submit" form="disband-form" class="btn-secondary bg-red-600/20 border-red-500/50 hover:bg-red-600/30 w-full">
											{{ .T "Disband Clan" }}
										</button>
									{{ else }}
										<form id="leave-form" method="post" action="/c/{{ .ClanID }}">
											{{ ieForm .Gin }}
										</form>
										<button type="submit" form="leave-form" class="btn-secondary bg-red-600/20 border-red-500/50 hover:bg-red-600/30 w-full">
											{{ .T "Leave Clan" }}
										</button>
									{{ end }}
								{{ else }}
									<div class="card bg-orange-900/20 border-orange-500/50 text-center">
										<p class="text-orange-300">Already joined a clan</p>
									</div>
								{{ end }}
							{{ end }}
						{{ else }}
							<div class="card bg-blue-900/20 border-blue-500/50 text-center">
								<a href="/login" class="text-blue-300 hover:text-blue-200">Please login to join a clan</a>
							</div>
						{{ end }}

						<div class="card">
							<h3 class="text-xl font-display font-bold mb-2">{{ .T "Clan Owner" }}</h3>
							<p class="text-gray-400 text-sm mb-4">{{ .T "The leader of the clan." }}</p>
							{{ template "clanGroup" (.Get "clans/members?id=%d&r=%d" .ClanID 8) }}
						</div>
					</div>
				</div>

				<!-- Members -->
				<div class="card">
					<h3 class="text-2xl font-display font-bold mb-6">{{ .T "Members" }}</h3>
					{{ template "clanMembers" (.Get "clans/members?id=%d&r=%d" .ClanID 1) }}
				</div>
			{{ end }}
		{{ end }}
	</div>
</div>

<!-- Stats Modal -->
<div id="stats-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
	<div class="modal-overlay" onclick="document.getElementById('stats-modal').classList.add('hidden')"></div>
	<div class="modal-content max-w-4xl max-h-[90vh] overflow-y-auto">
		<div class="flex items-center justify-between mb-4">
			<h2 class="text-2xl font-display font-bold">Statistics Details</h2>
			<button onclick="document.getElementById('stats-modal').classList.add('hidden')" class="text-gray-400 hover:text-white">
				<i class="fas fa-times text-2xl"></i>
			</button>
		</div>
		<table class="w-full" id="stats-data-table"></table>
	</div>
</div>
{{ end }}
